/**
 * Developed by eBrook Group.
 * Copyright Â© 2026 eBrook Group (https://www.ebrook.com.tw)
 */

<template>
  <FrontendLayout>
    <!-- è½®æ’­å›¾ -->
    <BannerCarousel v-if="banners.length > 0" :banners="banners" :autoplay="true" :interval="5000" />
    <!-- é»˜è®¤è½®æ’­å›¾ï¼ˆå½“æ²¡æœ‰é…ç½®æ—¶æ˜¾ç¤ºï¼‰ -->
    <section v-else class="relative h-96 overflow-hidden">
      <div class="absolute inset-0 bg-gradient-to-r from-red-600 via-orange-500 to-yellow-500">
        <div class="absolute inset-0 flex items-center justify-center">
          <div class="text-center text-white">
            <h1 class="text-5xl font-bold mb-4 animate-fade-in">ğŸ”¥ ç²¾é€‰ç«é”…å¥—é¤</h1>
            <p class="text-xl mb-8">é™æ—¶ä¼˜æƒ ï¼Œç«‹å³é¢„çº¦äº«å—ç¾å‘³</p>
            <router-link to="/frontend/reservation" class="bg-white text-red-600 px-8 py-3 rounded-full text-lg font-semibold hover:bg-gray-100 transition-all transform hover:scale-110 shadow-xl inline-block">
              ç«‹å³é¢„çº¦
            </router-link>
          </div>
        </div>
      </div>
    </section>

    <!-- å¿«æ·åŠŸèƒ½ -->
    <section class="py-12 bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
          <router-link to="/frontend/reservation" class="text-center group cursor-pointer transform transition-all hover:scale-110 block">
            <div class="w-20 h-20 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg group-hover:shadow-xl">
              <span class="text-3xl">ğŸ“…</span>
            </div>
            <h3 class="font-semibold text-gray-800">åœ¨çº¿é¢„çº¦</h3>
            <p class="text-sm text-gray-600 mt-1">è½»æ¾é¢„çº¦æ¡Œä½</p>
          </router-link>
          <router-link to="/frontend/queue" class="text-center group cursor-pointer transform transition-all hover:scale-110 block">
            <div class="w-20 h-20 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg group-hover:shadow-xl">
              <span class="text-3xl">ğŸ«</span>
            </div>
            <h3 class="font-semibold text-gray-800">æ’é˜Ÿå«å·</h3>
            <p class="text-sm text-gray-600 mt-1">å®æ—¶æŸ¥çœ‹æ’é˜Ÿ</p>
          </router-link>
          <router-link to="/frontend/points" class="text-center group cursor-pointer transform transition-all hover:scale-110 block">
            <div class="w-20 h-20 bg-gradient-to-br from-purple-400 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg group-hover:shadow-xl">
              <div class="text-3xl">â­</div>
            </div>
            <h3 class="font-semibold text-gray-800">ä¼šå‘˜ç§¯åˆ†</h3>
            <p class="text-sm text-gray-600 mt-1">æ¶ˆè´¹èµšç§¯åˆ†</p>
          </router-link>
          <router-link to="/frontend/lottery" class="text-center group cursor-pointer transform transition-all hover:scale-110 block">
            <div class="w-20 h-20 bg-gradient-to-br from-pink-400 to-pink-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg group-hover:shadow-xl">
              <span class="text-3xl">ğŸ</span>
            </div>
            <h3 class="font-semibold text-gray-800">å¹¸è¿æŠ½å¥–</h3>
            <p class="text-sm text-gray-600 mt-1">èµ¢å–ä¼˜æƒ åˆ¸</p>
          </router-link>
          <router-link to="/frontend/coupons" class="text-center group cursor-pointer transform transition-all hover:scale-110 block">
            <div class="w-20 h-20 bg-gradient-to-br from-yellow-400 to-yellow-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-lg group-hover:shadow-xl">
              <span class="text-3xl">ğŸ</span>
            </div>
            <h3 class="font-semibold text-gray-800">ä¼˜æƒ æ´»åŠ¨</h3>
            <p class="text-sm text-gray-600 mt-1">é™æ—¶ä¼˜æƒ </p>
          </router-link>
        </div>
      </div>
    </section>

    <!-- æ¨èèœå“ -->
    <section id="dishes" class="py-16 bg-gray-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
          <h2 class="text-4xl font-bold text-gray-900 mb-4">ğŸ”¥ æ¨èèœå“</h2>
          <p class="text-gray-600">ç²¾é€‰ç¾å‘³ï¼Œä¸å®¹é”™è¿‡</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div
            v-for="dish in dishes"
            :key="dish.id"
            class="bg-white rounded-xl shadow-md overflow-hidden transform transition-all duration-300 hover:scale-105 hover:shadow-xl cursor-pointer"
            @click="viewDish(dish)"
          >
            <div class="h-48 bg-gradient-to-br from-red-200 via-orange-200 to-yellow-200 flex items-center justify-center relative overflow-hidden cursor-pointer" @click.stop="previewImage(dish.image_url)">
              <img
                v-if="dish.image_url"
                :src="getImageUrl(dish.image_url)"
                :alt="dish.name"
                class="w-full h-full object-cover"
                @error="handleImageError"
              />
              <span v-else class="text-6xl">ğŸ²</span>
              <div v-if="dish.status === 'sold_out'" class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center">
                <span class="text-white font-bold text-xl">å·²å”®ç½„</span>
              </div>
            </div>
            <div class="p-5">
              <h3 class="text-xl font-bold text-gray-900 mb-2">{{ dish.name }}</h3>
              <p class="text-gray-600 text-sm mb-3 line-clamp-2">{{ dish.description || 'æš‚æ— æè¿°' }}</p>
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center">
                  <el-rate :model-value="Number(dish.average_rating) || 0" disabled size="small" />
                  <span class="text-xs text-gray-500 ml-2">({{ dish.review_count }})</span>
                </div>
                <span class="text-2xl font-bold text-red-600">Â¥{{ dish.price }}</span>
              </div>
              <router-link to="/frontend/dishes" class="w-full bg-gradient-to-r from-red-500 to-orange-500 text-white py-2 rounded-lg hover:from-red-600 hover:to-orange-600 transition-all transform hover:scale-105 block text-center">
                ç«‹å³ä¸‹å•
              </router-link>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ç”¨æˆ·è¯„ä»· -->
    <section id="reviews" class="py-16 bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
          <h2 class="text-4xl font-bold text-gray-900 mb-4">ğŸ’¬ ç”¨æˆ·è¯„ä»·</h2>
          <p class="text-gray-600">çœŸå®è¯„ä»·ï¼Œå€¼å¾—ä¿¡èµ–</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div
            v-for="review in reviews"
            :key="review.id"
            class="bg-gray-50 rounded-xl p-6 shadow-md hover:shadow-lg transition-all"
          >
            <div class="flex items-center mb-4">
              <div class="w-12 h-12 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center mr-3">
                <span class="text-white font-bold">{{ review.user?.nickname?.charAt(0) || 'U' }}</span>
              </div>
              <div>
                <h4 class="font-semibold text-gray-900">{{ review.user?.nickname || 'åŒ¿åç”¨æˆ·' }}</h4>
                <el-rate v-model="review.rating" disabled size="small" />
              </div>
            </div>
            <p class="text-gray-700 mb-2">{{ review.content || 'å¾ˆå¥½ï¼' }}</p>
            <p class="text-sm text-gray-500">{{ formatDate(review.created_at) }}</p>
          </div>
        </div>
      </div>
    </section>

    <!-- åº•éƒ¨ -->
    <footer class="bg-gray-900 text-white py-12">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div>
            <h3 class="text-xl font-bold mb-4">å…³äºæˆ‘ä»¬</h3>
            <p class="text-gray-400">ä¸“ä¸šç«é”…åº—ï¼Œæä¾›ä¼˜è´¨æœåŠ¡</p>
          </div>
          <div>
            <h3 class="text-xl font-bold mb-4">è”ç³»æ–¹å¼</h3>
            <p class="text-gray-400">ç”µè¯ï¼š400-123-4567</p>
            <p class="text-gray-400">åœ°å€ï¼šXXå¸‚XXåŒºXXè·¯XXå·</p>
          </div>
          <div>
            <h3 class="text-xl font-bold mb-4">è¥ä¸šæ—¶é—´</h3>
            <p class="text-gray-400">å‘¨ä¸€è‡³å‘¨æ—¥</p>
            <p class="text-gray-400">11:00 - 22:00</p>
          </div>
          <div>
            <h3 class="text-xl font-bold mb-4">å…³æ³¨æˆ‘ä»¬</h3>
            <div class="flex space-x-4">
              <span class="text-2xl">ğŸ“±</span>
              <span class="text-2xl">ğŸ’¬</span>
            </div>
          </div>
        </div>
        <div class="border-t border-gray-800 mt-8 pt-8 text-center text-gray-400">
          <p>&copy; 2026 ç«é”…åº—. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <!-- å›¾ç‰‡é¢„è§ˆå¯¹è¯æ¡† -->
    <el-dialog
      v-model="showImagePreview"
      width="80%"
      :show-close="true"
      align-center
      class="image-preview-dialog"
    >
      <div class="flex justify-center items-center">
        <img
          :src="previewImageUrl"
          alt="èœå“å›¾ç‰‡é¢„è§ˆ"
          class="max-w-full max-h-[80vh] object-contain"
          @error="handleImageError"
        />
      </div>
    </el-dialog>
  </FrontendLayout>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { ElMessage } from 'element-plus';
import FrontendLayout from '../../components/frontend/FrontendLayout.vue';
import BannerCarousel from '../../components/frontend/BannerCarousel.vue';
import { bannerApi } from '../../api/banner';
import { dishApi, type Dish } from '../../api/dish';
import type { Review } from '../../types';
import type { Banner } from '../../api/banner';

const dishes = ref<Dish[]>([]);
const reviews = ref<Review[]>([]);
const banners = ref<Banner[]>([]);

const formatDate = (date: string) => {
  if (!date) return '';
  return new Date(date).toLocaleDateString('zh-CN');
};

const viewDish = (dish: Dish) => {
  ElMessage.info(`æŸ¥çœ‹èœå“ï¼š${dish.name}`);
};

// å›¾ç‰‡é¢„è§ˆ
const showImagePreview = ref(false);
const previewImageUrl = ref('');

const previewImage = (imageUrl: string | null | undefined) => {
  if (!imageUrl) {
    ElMessage.warning('è¯¥èœå“æš‚æ— å›¾ç‰‡');
    return;
  }
  previewImageUrl.value = getImageUrl(imageUrl);
  showImagePreview.value = true;
};

// å¤„ç†å›¾ç‰‡URLï¼Œæ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
const getImageUrl = (url: string | null | undefined): string => {
  if (!url) return '';
  // å¦‚æœURLå·²ç»åŒ…å«æŸ¥è¯¢å‚æ•°ï¼Œæ·»åŠ &ï¼Œå¦åˆ™æ·»åŠ ?
  const separator = url.includes('?') ? '&' : '?';
  // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜ï¼Œä½†åªä½¿ç”¨æ—¥æœŸéƒ¨åˆ†ï¼Œè¿™æ ·åŒä¸€å¤©å†…çš„æ›´æ–°ä¼šè¢«ç¼“å­˜
  const timestamp = new Date().toISOString().split('T')[0].replace(/-/g, '');
  return `${url}${separator}_t=${timestamp}`;
};

// å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
const handleImageError = (event: Event) => {
  const img = event.target as HTMLImageElement;
  // å¦‚æœå›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œéšè—å›¾ç‰‡ï¼Œæ˜¾ç¤ºé»˜è®¤å ä½ç¬¦
  img.style.display = 'none';
};

const fetchDishes = async () => {
  try {
    const response = await dishApi.getList({ per_page: 8, sort: 'sales_desc' });
    if (response.code === 200 && response.data) {
      dishes.value = response.data.dishes || [];
    }
  } catch (error: any) {
    console.error('è·å–èœå“åˆ—è¡¨å¤±è´¥:', error);
    ElMessage.error(error.response?.data?.message || error.message || 'è·å–èœå“åˆ—è¡¨å¤±è´¥');
  }
};

const fetchReviews = async () => {
  reviews.value = [
    {
      id: 1,
      user_id: 1,
      order_id: 1,
      dish_id: 1,
      rating: 5,
      content: 'éå¸¸å¥½åƒï¼éº»è¾£é”…åº•å‘³é“æ­£å®—ï¼ŒæœåŠ¡ä¹Ÿå¾ˆå¥½ï¼Œå¼ºçƒˆæ¨èï¼',
      status: 'approved',
      created_at: new Date().toISOString(),
      user: { id: 1, nickname: 'å¼ **' },
    },
    {
      id: 2,
      user_id: 2,
      order_id: 2,
      dish_id: 3,
      rating: 5,
      content: 'è‚¥ç‰›å¾ˆæ–°é²œï¼Œå£æ„Ÿå¾ˆå¥½ï¼Œä¸‹æ¬¡è¿˜ä¼šå†æ¥ï¼',
      status: 'approved',
      created_at: new Date().toISOString(),
      user: { id: 2, nickname: 'æ**' },
    },
    {
      id: 3,
      user_id: 3,
      order_id: 3,
      dish_id: 4,
      rating: 4,
      content: 'è™¾å¾ˆæ–°é²œï¼Œå°±æ˜¯ä»·æ ¼æœ‰ç‚¹è´µï¼Œä¸è¿‡å‘³é“ç¡®å®ä¸é”™',
      status: 'approved',
      created_at: new Date().toISOString(),
      user: { id: 3, nickname: 'ç‹**' },
    },
  ];
};

const fetchBanners = async () => {
  try {
    const response = await bannerApi.getList();
    if (response && response.code === 200 && response.data) {
      banners.value = response.data.banners || [];
    }
  } catch (error) {
    console.error('è·å–è½®æ’­å›¾å¤±è´¥:', error);
    // é™é»˜å¤±è´¥ï¼Œä¸å½±å“é¡µé¢æ˜¾ç¤º
  }
};

onMounted(() => {
  fetchBanners();
  fetchDishes();
  fetchReviews();
});
</script>

<style scoped>
@keyframes fade-in {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.animate-fade-in {
  animation: fade-in 1s ease-out;
}

.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

:deep(.image-preview-dialog .el-dialog__body) {
  padding: 20px;
  display: flex;
  justify-content: center;
  align-items: center;
}
</style>
