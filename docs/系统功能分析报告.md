# 火锅店小程序系统 - 功能分析报告

**Developed by eBrook Group.**  
**Copyright © 2026 eBrook Group (https://www.ebrook.com.tw)**

---

## 目录

1. [系统概述](#1-系统概述)
2. [核心功能模块详解](#2-核心功能模块详解)
3. [与传统火锅餐饮系统的对比分析](#3-与传统火锅餐饮系统的对比分析)
4. [技术架构特点](#4-技术架构特点)
5. [业务流程详解](#5-业务流程详解)
6. [数据模型设计](#6-数据模型设计)
7. [创新亮点总结](#7-创新亮点总结)

---

## 1. 系统概述

### 1.1 系统定位

本系统是一套面向火锅餐饮行业的**全流程数字化管理解决方案**，涵盖用户端小程序和管理端后台，旨在通过技术创新提升用户体验、优化运营效率、增强客户粘性。

### 1.2 核心价值

- **用户体验提升**：可视化桌位选择、实时排队信息、便捷的预约和评价流程
- **运营效率优化**：自动化业务流程、智能数据分析、异常监控预警
- **客户关系管理**：积分会员体系、精准营销、评价追踪优化
- **数据驱动决策**：多维度统计分析、异常检测、运营报表

### 1.3 技术栈

- **后端**：Laravel 10+ (PHP 8.2+)
- **前端**：Vue 3 + TypeScript + Element Plus
- **数据库**：MySQL 8.0+ / MariaDB 10.6+
- **认证**：Laravel Sanctum
- **支付**：微信支付集成
- **架构模式**：前后端分离、RESTful API、事件驱动

---

## 2. 核心功能模块详解

### 2.1 预约管理系统

#### 2.1.1 功能概述

提供完整的在线预约服务，支持可视化桌位选择、时间段预约、预约定金支付等功能。

#### 2.1.2 核心功能

**1. 可视化桌位选择**
- **地图式布局展示**：桌位以坐标形式展示在餐厅布局图上
- **实时状态显示**：
  - `available`：可用
  - `reserved`：已预约
  - `occupied`：使用中
  - `maintenance`：维护中
- **智能推荐**：根据用餐人数自动筛选合适的桌位
- **桌位信息**：显示桌位名称、容量、类型（窗边/角落/中央）

**2. 时间段预约**
- 支持选择具体日期（YYYY-MM-DD格式）
- 支持选择具体时间段（HH:mm格式，如18:00）
- 自动检查时间冲突，防止重复预约
- 支持特殊需求备注（如生日庆祝、儿童座椅等）

**3. 预约定金机制**
- **在线支付定金**：支持微信支付
- **定金金额配置化**：可在后台配置定金金额（默认50元）
- **定金抵扣**：定金可在订单结算时抵扣
- **15分钟确认机制**：预约创建后15分钟内需确认，否则自动过期
- **过期自动释放**：超时未确认自动释放桌位资源

**4. 预约状态管理**
- `pending`：待确认（15分钟内需确认）
- `confirmed`：已确认
- `cancelled`：已取消
- `completed`：已完成
- `expired`：已过期

**5. 预约编码生成**
- 格式：`RES + YYYYMMDD + 6位序号`
- 示例：`RES20260115000001`
- 每日独立计数，便于识别和管理

**6. 幂等性保证**
- 使用`idempotency_key`防止重复提交
- 相同密钥的重复请求返回已有预约信息
- 保证高并发场景下的数据一致性

#### 2.1.3 技术实现亮点

- **数据库锁机制**：使用`lockForUpdate()`防止并发冲突
- **事务保证**：预约创建和桌位状态更新在同一事务中
- **索引优化**：对`date`、`time_slot`、`status`建立联合索引
- **缓存优化**：可用桌位列表使用缓存提升性能

---

### 2.2 评价管理系统

#### 2.2.1 功能概述

提供多维度评价功能，支持评分、文字、图片、标签，并具备评价追踪优化机制。

#### 2.2.2 核心功能

**1. 多维度评价**
- **评分系统**：1-5星评分
- **文字评价**：最多500字，支持富文本
- **图片上传**：最多3张图片，支持预览和删除
- **标签系统**：预设标签选择（如"味道好"、"服务佳"、"环境优美"等）
- **菜品关联**：每个评价关联具体菜品，支持一订单多菜品评价

**2. 自动审核机制**
- **不文明语言过滤**：
  - 中英文敏感词库检测
  - 评价内容和标签联合检测
  - 自动拒绝包含不文明语言的评价
- **频率限制**：1小时内最多提交5条评价，防止刷评
- **自动通过**：通过审核的评价自动设置为`approved`状态

**3. 评价追踪优化机制**（核心创新功能）

**采纳建议流程**：
1. 管理员查看评价，发现有价值的建议
2. 点击"采纳"按钮，评价状态变为`is_adopted = true`
3. 自动进入追踪状态（`tracking_status = in_progress`）
4. 记录采纳信息（谁采纳、何时采纳）

**追踪优化流程**：
- **状态管理**：
  - `pending`：待处理
  - `in_progress`：优化中
  - `completed`：已完成
  - `cancelled`：已取消
- **追踪更新记录**：
  - 记录每次状态变更
  - 记录优化措施和进展
  - 记录操作管理员和时间
  - 支持添加文字说明

**用户可见性**：
- 用户可查看自己评价的追踪状态
- 公开显示被采纳建议的优化进展
- 形成"评价-采纳-优化-反馈"的完整闭环

**4. 管理员互动功能**
- **回复评价**：管理员可回复用户评价，显示在评价下方
- **审核评价**：支持手动审核（虽然已自动审核，但保留手动功能）
- **采纳建议**：一键采纳有价值的建议
- **状态更新**：更新追踪优化状态
- **添加更新**：添加优化进展说明

**5. 菜品评分统计**
- **自动计算**：评价通过后自动更新菜品平均分
- **评价数量**：统计每个菜品的评价总数
- **评分分布**：统计1-5星评分的分布情况
- **实时更新**：每次评价通过后实时更新统计

**6. 订单完成联动**
- 订单状态为`pending_review`时，用户可对菜品进行评价
- 当订单中所有菜品都已评价后，订单自动变为`completed`状态
- 无需用户手动确认订单完成

#### 2.2.3 技术实现亮点

- **Observer模式**：评价创建和状态变更自动触发积分奖励
- **内容安全**：`ProfanityFilterService`提供不文明语言检测
- **频率限制**：使用Cache实现频率限制
- **数据一致性**：使用事务保证评价创建和统计更新的原子性

---

### 2.3 排队叫号系统

#### 2.3.1 功能概述

提供实时排队叫号服务，支持在线排队、实时位置查询、智能叫号等功能。

#### 2.3.2 核心功能

**1. 加入排队**
- 用户选择用餐人数
- 可选择桌位类型偏好（可选）
- 系统自动分配排队号
- 检查用户是否已在队列中（防止重复排队）

**2. 排队号生成**
- **智能前缀**：根据时间段自动生成不同前缀
  - 17:00-20:00：A前缀（晚餐高峰期）
  - 11:00-14:00：B前缀（午餐高峰期）
  - 其他时间：C前缀
- **格式**：`前缀 + 3位序号`（如`A001`、`B023`）
- **每日计数**：每日从001开始计数

**3. 实时位置查询**
- **当前位置**：显示用户在队列中的位置
- **前方人数**：显示前方还有多少人
- **预计等待时间**：根据前方人数估算等待时间（简化算法：每桌30分钟）
- **排队状态**：
  - `waiting`：等待中
  - `called`：已叫号
  - `completed`：已完成
  - `cancelled`：已取消

**4. 叫号管理**（管理端功能）
- 管理员可查看当前排队列表
- 按顺序叫号，更新状态为`called`
- 记录叫号时间

#### 2.3.3 技术实现亮点

- **位置计算**：使用`position`字段排序，高效计算前方人数
- **并发控制**：使用数据库锁防止重复排队
- **智能算法**：根据时间段智能生成排队号前缀

---

### 2.4 积分会员系统

#### 2.4.1 功能概述

提供完整的积分会员体系，支持多来源积分获得、积分兑换、会员等级、积分过期管理等功能。

#### 2.4.2 核心功能

**1. 多来源积分获得**

**订单支付积分**：
- **计算规则**：`积分 = 订单金额 × 基础比例 × 会员等级倍数`
- **基础比例**：1元 = 1积分（可配置）
- **会员等级倍数**：
  - 青铜：1.0倍
  - 白银：1.2倍
  - 黄金：1.5倍
  - 白金：2.0倍
- **最低消费限制**：可配置最低消费金额（如满50元才获得积分）
- **单次上限**：可配置单次订单最大积分限制
- **触发时机**：订单状态变为`paid`时自动发放

**评价奖励积分**：
- **基础积分**：完成评价获得50积分（可配置）
- **图片奖励**：带图片评价额外+20积分（可配置）
- **首次评价奖励**：首次评价额外+30积分（可配置）
- **触发时机**：评价状态变为`approved`时自动发放

**评价采纳奖励**：
- **采纳奖励**：评价被采纳获得200积分（可配置）
- **触发时机**：评价`is_adopted`从`false`变为`true`时自动发放

**2. 会员等级系统**

**等级划分**：
- **青铜**：0-999积分
- **白银**：1000-4999积分
- **黄金**：5000-9999积分
- **白金**：10000+积分

**等级权益**：
- 不同等级享受不同的积分获得倍数
- 等级越高，积分获得越多
- 自动升级：积分达到阈值自动升级

**3. 积分状态管理**

**积分类型**：
- **总积分**（`total_points`）：用户累计获得的所有积分
- **可用积分**（`available_points`）：当前可使用的积分
- **冻结积分**（`frozen_points`）：兑换优惠券时冻结的积分

**积分流转**：
- 获得积分：`total_points`和`available_points`同时增加
- 兑换优惠券：`available_points`减少，`frozen_points`增加
- 优惠券使用：`frozen_points`减少（积分不返还）
- 优惠券过期：`frozen_points`减少，`available_points`增加（积分返还）

**4. 积分兑换系统**

**兑换流程**：
1. 用户选择优惠券
2. 检查可用积分是否足够
3. 扣除可用积分，增加冻结积分
4. 生成用户优惠券（唯一兑换码）
5. 记录交易流水
6. 减少优惠券库存

**幂等性保证**：
- 使用`idempotency_key`防止重复兑换
- 相同密钥的重复请求返回已有兑换信息

**5. 积分过期管理**

**过期机制**：
- **有效期**：积分获得后365天过期（可配置）
- **过期处理**：定时任务自动处理过期积分
- **过期提醒**：用户可查看30天内即将过期的积分
- **过期记录**：过期积分记录在交易流水中

**过期策略**：
- 按获得时间先后顺序过期（FIFO）
- 过期积分从`available_points`中扣除
- 记录过期交易流水（`type = expire`）

**6. 积分统计与分析**

**日报统计**：
- 每日获得积分总数
- 每日兑换积分总数
- 每日过期积分总数
- 每日活跃用户数

**排行榜**：
- 按总积分排序
- 显示前100名用户
- 显示用户昵称、头像、等级

**来源统计**：
- 统计不同来源的积分获得情况
- 来源类型：`order`、`review`、`review_adoption`等
- 统计每个来源的总积分和交易次数

**7. 积分异常检测系统**（核心创新功能）

**检测类型**：

**异常大额积分获得**：
- 检测24小时内获得超过10000积分的交易
- 超过20000积分标记为高严重程度
- 记录用户ID、交易ID、积分数量、来源类型

**异常频繁交易**：
- 检测1小时内交易次数超过50次的用户
- 超过100次标记为高严重程度
- 记录用户ID、交易次数、时间窗口

**异常用户行为**：
- 检测7天内日均获得积分超过5000的用户
- 检测可用积分大于总积分的异常情况
- 记录异常类型和详细信息

**积分流失异常**：
- 检测30天内积分过期率超过30%的情况
- 分析过期积分与获得积分的比例
- 预警积分流失风险

**异常统计摘要**：
- 总异常数量
- 高严重程度数量
- 中严重程度数量
- 按类型分类统计

#### 2.4.3 技术实现亮点

- **Observer模式**：订单和评价状态变更自动触发积分发放
- **规则配置化**：积分规则存储在数据库，支持动态配置
- **缓存优化**：积分规则使用缓存提升查询性能
- **事务保证**：积分操作使用事务保证数据一致性
- **幂等性保证**：关键操作支持幂等性检查
- **定时任务**：积分过期处理使用定时任务自动执行

---

### 2.5 订单管理系统

#### 2.5.1 功能概述

提供完整的订单管理功能，支持订单创建、支付、优惠抵扣、状态管理等。

#### 2.5.2 核心功能

**1. 订单创建**
- 关联桌位（可选）
- 关联预约（可选）
- 添加订单项（菜品）
- 计算订单金额

**2. 支付集成**
- 支持微信支付
- 支持多种支付方式（可扩展）
- 支付成功后自动更新订单状态

**3. 优惠抵扣**
- **预约定金抵扣**：预约时支付的定金可在订单结算时抵扣
- **积分抵扣**：使用积分抵扣订单金额（可配置比例和上限）
- **优惠券使用**：使用优惠券抵扣订单金额

**4. 订单状态管理**
- `pending`：待支付
- `paid`：已支付
- `pending_review`：待评价
- `completed`：已完成
- `cancelled`：已取消

**5. 订单完成联动**
- 订单支付后自动发放积分
- 订单所有菜品评价完成后自动完成订单

#### 2.5.3 技术实现亮点

- **Observer模式**：订单状态变更自动触发积分发放
- **事务保证**：订单创建和支付在同一事务中
- **幂等性保证**：支付接口支持幂等性检查

---

### 2.6 管理后台系统

#### 2.6.1 功能概述

提供完整的管理后台功能，支持预约管理、评价管理、用户管理、数据统计等。

#### 2.6.2 核心功能

**1. 权限管理系统**
- **基于角色的权限控制**（RBAC）：
  - 角色管理：创建、编辑、删除角色
  - 权限管理：细粒度权限控制
  - 用户角色分配：为用户分配角色
- **权限类型**：
  - `reservations.view`：查看预约
  - `reviews.view`：查看评价
  - `reviews.approve`：审核评价
  - `reviews.reply`：回复评价
  - `reviews.adopt`：采纳评价
  - `reviews.track`：追踪优化
  - `points.view`：查看积分
  - `points.update`：调整积分
  - `orders.view`：查看订单
  - `orders.update`：更新订单
  - 等等...

**2. 预约管理**
- 查看预约列表（支持筛选和搜索）
- 查看预约详情
- 确认预约
- 取消预约
- 查看预约统计

**3. 评价管理**
- 查看评价列表（支持筛选和搜索）
- 查看评价详情
- 审核评价（通过/拒绝）
- 回复评价
- 采纳评价建议
- 追踪优化状态
- 添加追踪更新

**4. 桌位管理**
- **可视化桌位布局**：
  - 地图式布局展示
  - 支持拖拽调整桌位位置
  - 实时显示桌位状态
- **桌位信息管理**：
  - 创建、编辑、删除桌位
  - 设置桌位容量、类型、状态
  - 批量更新桌位位置

**5. 区域管理**
- 创建、编辑、删除餐厅区域
- 批量更新区域信息
- 区域与桌位关联

**6. 用户管理**
- 查看用户列表（支持筛选和搜索）
- 查看用户详情
- 编辑用户信息
- 删除用户（软删除）

**7. 积分管理**
- **积分查询**：
  - 查看用户积分详情
  - 查看积分交易流水
- **积分调整**：
  - 手动调整用户积分
  - 记录调整原因
- **积分规则配置**：
  - 配置订单积分规则
  - 配置评价积分规则
  - 配置采纳奖励规则
  - 配置积分过期规则
- **积分统计**：
  - 查看积分日报
  - 查看积分排行榜
  - 查看积分来源统计
  - 查看异常检测结果

**8. 优惠券管理**
- 创建、编辑、删除优惠券
- 设置优惠券类型、面额、所需积分
- 设置优惠券有效期和库存
- 查看优惠券使用统计

**9. 订单管理**
- 查看订单列表（支持筛选和搜索）
- 查看订单详情
- 更新订单状态
- 取消订单
- 完成订单

**10. 配置管理**
- 系统配置管理（如预约定金金额）
- 轮播图管理
- 文件上传管理

**11. 管理员管理**
- 创建、编辑、删除管理员
- 分配角色和权限
- 管理员登录日志

#### 2.6.3 技术实现亮点

- **权限中间件**：每个路由使用权限中间件保护
- **数据权限**：支持数据级别的权限控制
- **审计日志**：所有关键操作记录审计日志

---

## 3. 与传统火锅餐饮系统的对比分析

### 3.1 预约系统对比

| 功能点 | 传统系统 | 本系统 | 优势说明 |
|--------|---------|--------|----------|
| **预约方式** | 电话预约 | 在线预约 | 24小时可预约，无需人工接听 |
| **桌位选择** | 电话描述或简单列表 | 可视化地图式选择 | 直观明了，用户可自主选择心仪桌位 |
| **时间冲突检测** | 人工检查 | 自动检测 | 实时检测，防止重复预约 |
| **预约确认** | 电话确认 | 在线确认+15分钟机制 | 自动化流程，防止恶意占位 |
| **预约定金** | 无或现金支付 | 在线支付+自动抵扣 | 便捷支付，自动抵扣订单 |
| **预约提醒** | 人工电话提醒 | 自动消息提醒 | 准时提醒，不遗漏 |
| **桌位状态** | 人工记录 | 实时自动更新 | 状态准确，避免冲突 |

**核心优势**：
- ✅ **用户体验**：可视化选择，操作便捷
- ✅ **运营效率**：自动化流程，减少人工成本
- ✅ **数据准确性**：系统自动管理，避免人为错误

---

### 3.2 评价系统对比

| 功能点 | 传统系统 | 本系统 | 优势说明 |
|--------|---------|--------|----------|
| **评价方式** | 纸质评价表或简单评分 | 多维度评价（评分+文字+图片+标签） | 信息丰富，便于其他用户参考 |
| **评价审核** | 人工审核或无需审核 | 自动不文明语言过滤+自动通过 | 保证内容质量，提升审核效率 |
| **评价展示** | 简单列表展示 | 多维度展示+统计分布 | 信息全面，便于用户决策 |
| **评价反馈** | 无后续跟进 | 管理员回复+采纳建议+追踪优化 | 形成闭环，提升服务质量 |
| **评价激励** | 无或简单奖励 | 积分奖励+采纳奖励 | 激励用户评价，提升评价质量 |
| **评价统计** | 简单平均分 | 平均分+评价数+分布统计 | 数据全面，便于分析 |

**核心优势**：
- ✅ **评价追踪优化**：采纳建议并追踪改进，形成"评价-采纳-优化-反馈"闭环
- ✅ **内容安全**：自动不文明语言过滤，保证内容质量
- ✅ **用户激励**：积分奖励机制，鼓励用户评价
- ✅ **数据价值**：评价数据转化为改进措施，提升服务质量

---

### 3.3 排队系统对比

| 功能点 | 传统系统 | 本系统 | 优势说明 |
|--------|---------|--------|----------|
| **排队方式** | 现场取号 | 在线排队 | 无需到店即可排队 |
| **排队信息** | 仅排队号 | 排队号+位置+预计时间 | 信息全面，用户可合理安排时间 |
| **叫号方式** | 人工叫号 | 系统叫号+消息通知 | 自动化流程，不遗漏 |
| **排队统计** | 无 | 实时统计+数据分析 | 便于运营分析 |

**核心优势**：
- ✅ **用户体验**：在线排队，无需到店等待
- ✅ **信息透明**：实时位置和预计时间，用户可合理安排
- ✅ **运营效率**：自动化叫号，减少人工成本

---

### 3.4 积分系统对比

| 功能点 | 传统系统 | 本系统 | 优势说明 |
|--------|---------|--------|----------|
| **积分获得** | 仅消费积分 | 多来源积分（消费+评价+采纳） | 激励用户多维度参与 |
| **会员等级** | 简单等级 | 四级等级+等级倍数加成 | 等级权益明确，激励升级 |
| **积分兑换** | 简单兑换 | 兑换优惠券+冻结机制 | 兑换流程完善，防止滥用 |
| **积分过期** | 无过期机制 | 自动过期+过期提醒 | 促进积分使用，提升活跃度 |
| **积分统计** | 简单记录 | 多维度统计+异常检测 | 数据全面，便于分析 |
| **异常检测** | 无 | 自动异常检测+预警 | 防止积分滥用，保证系统安全 |

**核心优势**：
- ✅ **多来源激励**：消费、评价、采纳等多维度获得积分
- ✅ **智能过期**：自动过期机制，促进积分使用
- ✅ **异常检测**：自动检测异常行为，保证系统安全
- ✅ **数据分析**：多维度统计，便于运营决策

---

### 3.5 订单系统对比

| 功能点 | 传统系统 | 本系统 | 优势说明 |
|--------|---------|--------|----------|
| **订单创建** | 人工记录 | 系统自动创建 | 准确高效 |
| **支付方式** | 现金或POS机 | 在线支付+多种方式 | 便捷支付，支持多种方式 |
| **优惠抵扣** | 人工计算 | 自动计算+多种优惠 | 准确计算，支持多种优惠 |
| **订单状态** | 人工更新 | 自动更新+状态联动 | 状态准确，自动流转 |
| **积分奖励** | 无或人工发放 | 自动发放 | 自动化流程，不遗漏 |

**核心优势**：
- ✅ **自动化流程**：订单创建、支付、积分奖励全自动
- ✅ **多种优惠**：支持定金、积分、优惠券等多种优惠
- ✅ **状态联动**：订单状态自动流转，无需人工干预

---

### 3.6 管理后台对比

| 功能点 | 传统系统 | 本系统 | 优势说明 |
|--------|---------|--------|----------|
| **权限管理** | 简单权限或无需权限 | 基于角色的细粒度权限控制 | 安全可靠，权限清晰 |
| **数据统计** | 简单报表或无统计 | 多维度统计分析+图表展示 | 数据全面，便于决策 |
| **异常监控** | 无 | 自动异常检测+预警 | 及时发现问题，保证系统安全 |
| **操作审计** | 无或简单日志 | 完整审计日志+操作追踪 | 可追溯，便于审计 |

**核心优势**：
- ✅ **权限安全**：细粒度权限控制，保证系统安全
- ✅ **数据驱动**：多维度统计分析，支持数据驱动决策
- ✅ **异常监控**：自动异常检测，及时发现问题
- ✅ **操作审计**：完整审计日志，可追溯所有操作

---

## 4. 技术架构特点

### 4.1 前后端分离架构

**后端（Laravel）**：
- RESTful API设计
- 统一的响应格式
- 完善的错误处理
- API版本控制（v1）

**前端（Vue 3 + TypeScript）**：
- 组件化开发
- 类型安全
- 响应式设计
- 现代化UI（Element Plus）

**优势**：
- 前后端独立开发和部署
- 易于扩展和维护
- 支持多端接入（小程序、Web、App）

---

### 4.2 事件驱动架构

**Observer模式**：
- `OrderObserver`：订单状态变更自动触发积分发放
- `ReviewObserver`：评价创建和状态变更自动触发积分发放
- `UserCouponObserver`：优惠券使用和过期自动处理积分

**优势**：
- 业务逻辑解耦
- 自动化流程
- 易于扩展新的事件处理

---

### 4.3 服务化设计

**Service层职责**：
- `ReservationService`：预约业务逻辑
- `ReviewService`：评价业务逻辑
- `PointService`：积分业务逻辑
- `QueueService`：排队业务逻辑
- `PointRuleService`：积分规则管理
- `PointExpirationService`：积分过期管理
- `PointStatisticsService`：积分统计分析
- `PointAnomalyDetectionService`：积分异常检测
- `ProfanityFilterService`：不文明语言过滤

**优势**：
- 业务逻辑集中管理
- 易于测试和维护
- 代码复用性高

---

### 4.4 数据一致性保证

**事务机制**：
- 关键操作使用数据库事务
- 保证数据一致性
- 防止部分成功的情况

**幂等性保证**：
- 使用`idempotency_key`防止重复操作
- 关键接口支持幂等性检查
- 保证高并发场景下的数据一致性

**数据库锁**：
- 使用`lockForUpdate()`防止并发冲突
- 保证资源分配的准确性

---

### 4.5 性能优化

**缓存策略**：
- 积分规则缓存
- 可用桌位列表缓存
- 频率限制缓存

**数据库优化**：
- 合理的索引设计
- 查询优化
- 避免N+1查询问题

**前端优化**：
- 组件懒加载
- 图片懒加载
- 虚拟滚动（大数据量）

---

### 4.6 安全性设计

**认证授权**：
- Laravel Sanctum Token认证
- 基于角色的权限控制（RBAC）
- 细粒度权限管理

**数据安全**：
- 输入验证和清理
- SQL注入防护（使用ORM）
- XSS防护（输出转义）
- CSRF防护

**内容安全**：
- 不文明语言过滤
- 频率限制
- 异常检测

---

## 5. 业务流程详解

### 5.1 预约流程

```
用户选择日期和时间段
    ↓
系统返回可用桌位列表（可视化展示）
    ↓
用户选择桌位，填写联系人信息
    ↓
提交预约请求（携带idempotency_key）
    ↓
系统检查：
  - 桌位是否可用（数据库锁）
  - 时间段是否冲突
  - 幂等性检查
    ↓
创建预约记录（status: pending）
占用桌位资源（status: reserved）
    ↓
15分钟内用户确认预约
    ↓
预约状态变为confirmed
    ↓
预约日期前1小时发送提醒通知
    ↓
用户到店用餐
    ↓
预约状态变为completed
```

**异常处理**：
- 15分钟内未确认 → 自动过期，释放桌位
- 用户取消 → 状态变为cancelled，释放桌位
- 时间冲突 → 返回错误，提示选择其他时间段

---

### 5.2 评价流程

```
用户完成订单，订单状态变为pending_review
    ↓
用户进入订单详情页，点击"评价"
    ↓
选择菜品，填写评分、内容、上传图片、选择标签
    ↓
提交评价请求
    ↓
系统检查：
  - 订单是否存在且处于pending_review状态
  - 是否已评价过该菜品
  - 频率限制检查（1小时最多5条）
    ↓
不文明语言过滤
    ↓
创建评价记录（status: approved，自动通过）
    ↓
自动发放评价积分奖励
    ↓
更新菜品评分统计
    ↓
检查订单是否所有菜品都已评价
    ↓
是 → 订单状态自动变为completed
否 → 订单保持pending_review状态
```

**管理员流程**：
```
管理员查看评价列表
    ↓
发现有价值的建议，点击"采纳"
    ↓
评价状态变为is_adopted=true
tracking_status变为in_progress
    ↓
自动发放采纳奖励积分
    ↓
管理员添加追踪更新记录
    ↓
更新追踪状态（in_progress → completed）
    ↓
用户可查看优化进展
```

---

### 5.3 积分获得流程

**订单支付积分**：
```
订单创建
    ↓
用户支付订单
    ↓
订单状态变为paid
    ↓
OrderObserver触发
    ↓
检查是否已为该订单发放过积分
    ↓
否 → 计算应得积分（订单金额 × 比例 × 等级倍数）
    ↓
增加用户总积分和可用积分
    ↓
检查并更新会员等级
    ↓
记录积分交易流水
    ↓
安排积分过期时间（365天后）
```

**评价积分**：
```
用户提交评价
    ↓
评价创建（status: approved）
    ↓
ReviewObserver触发
    ↓
检查是否已为该评价发放过积分
    ↓
否 → 计算应得积分（基础+图片+首次评价）
    ↓
增加用户总积分和可用积分
    ↓
检查并更新会员等级
    ↓
记录积分交易流水
    ↓
安排积分过期时间（365天后）
```

**采纳奖励积分**：
```
管理员采纳评价建议
    ↓
评价is_adopted变为true
    ↓
ReviewObserver触发
    ↓
检查是否已为该评价发放过采纳积分
    ↓
否 → 计算应得积分（默认200积分）
    ↓
增加用户总积分和可用积分
    ↓
检查并更新会员等级
    ↓
记录积分交易流水
    ↓
安排积分过期时间（365天后）
```

---

### 5.4 积分兑换流程

```
用户查看可用优惠券列表
    ↓
选择优惠券，点击"兑换"
    ↓
系统检查：
  - 优惠券是否可用（is_active=true）
  - 库存是否充足
  - 用户可用积分是否足够
    ↓
幂等性检查（idempotency_key）
    ↓
扣除用户可用积分
增加用户冻结积分
    ↓
减少优惠券库存
    ↓
生成用户优惠券（唯一兑换码）
    ↓
记录积分交易流水（type: redeem）
    ↓
返回兑换结果
```

**优惠券使用/过期**：
```
优惠券使用：
  - 冻结积分减少（积分不返还）
  - 用户优惠券状态变为used

优惠券过期：
  - 冻结积分减少
  - 可用积分增加（积分返还）
  - 记录积分交易流水（type: adjust）
```

---

### 5.5 积分过期流程

```
定时任务（每日执行）
    ↓
查询所有已过期的积分交易（expire_at <= now()）
    ↓
按用户分组处理
    ↓
对每个用户：
  - 计算过期积分总数
  - 从可用积分中扣除
  - 记录积分交易流水（type: expire）
    ↓
更新用户积分余额
```

---

## 6. 数据模型设计

### 6.1 核心数据表

**用户表（users）**：
- 基本信息：昵称、头像、手机号等
- 微信信息：openid、unionid等

**预约表（reservations）**：
- 预约信息：预约编码、日期、时间段、人数等
- 状态管理：status、expires_at、confirmed_at等
- 定金信息：deposit_amount、deposit_status等

**评价表（reviews）**：
- 评价内容：rating、content、images、tags等
- 状态管理：status、reviewed_at等
- 追踪优化：is_adopted、tracking_status、tracking_updates等

**订单表（orders）**：
- 订单信息：订单号、金额、状态等
- 优惠信息：deposit_discount、points_discount等
- 支付信息：payment_method、paid_at等

**积分表（member_points）**：
- 积分信息：total_points、available_points、frozen_points
- 等级信息：level

**积分交易表（point_transactions）**：
- 交易信息：type、points、balance_after
- 来源信息：source_type、source_id、description
- 过期信息：expire_at

**积分规则表（point_rules）**：
- 规则配置：rule_key、config、is_active

**积分统计表（point_statistics）**：
- 统计信息：stat_date、total_earned、total_redeemed等

**优惠券表（coupons）**：
- 优惠券信息：name、type、value、points_required等
- 有效期：valid_from、valid_to
- 库存：stock

**用户优惠券表（user_coupons）**：
- 关联信息：user_id、coupon_id
- 状态信息：status、expires_at
- 使用信息：used_at

**桌位表（tables）**：
- 桌位信息：name、capacity、type
- 位置信息：position_x、position_y
- 状态信息：status

**排队表（queues）**：
- 排队信息：queue_number、position、status
- 用户信息：user_id、guest_count

---

### 6.2 数据关系

```
users
  ├── reservations (1:N)
  ├── orders (1:N)
  ├── reviews (1:N)
  ├── member_points (1:1)
  ├── point_transactions (1:N)
  └── user_coupons (1:N)

reservations
  ├── users (N:1)
  ├── tables (N:1)
  └── orders (1:1)

orders
  ├── users (N:1)
  ├── tables (N:1)
  ├── reservations (1:1)
  ├── order_items (1:N)
  └── reviews (1:N)

reviews
  ├── users (N:1)
  ├── orders (N:1)
  └── dishes (N:1)

member_points
  └── users (1:1)

point_transactions
  └── users (N:1)

coupons
  └── user_coupons (1:N)

tables
  ├── reservations (1:N)
  └── orders (1:N)
```

---

## 7. 创新亮点总结

### 7.1 评价追踪优化机制

**创新点**：
- 管理员可采纳用户评价中的建议
- 系统追踪优化进度，记录优化措施
- 用户可查看优化进展，形成闭环反馈

**价值**：
- 将用户评价转化为实际改进措施
- 提升用户参与感和满意度
- 持续优化服务质量

---

### 7.2 积分异常检测系统

**创新点**：
- 自动检测异常大额积分获得
- 自动检测异常频繁交易
- 自动检测异常用户行为
- 自动检测积分流失异常

**价值**：
- 防止积分滥用和刷分行为
- 保证积分系统公平性
- 及时发现和处理异常情况

---

### 7.3 可视化桌位选择

**创新点**：
- 地图式桌位布局展示
- 实时显示桌位状态
- 支持拖拽调整桌位位置（管理端）
- 智能推荐合适桌位

**价值**：
- 提升用户体验，直观明了
- 减少沟通成本
- 提升预约成功率

---

### 7.4 多维度积分获得机制

**创新点**：
- 订单支付积分（按金额和等级）
- 评价奖励积分（基础+图片+首次）
- 评价采纳奖励积分
- 会员等级倍数加成

**价值**：
- 激励用户多维度参与
- 提升用户活跃度
- 促进用户评价和反馈

---

### 7.5 智能积分过期管理

**创新点**：
- 自动过期机制（365天）
- 过期提醒（30天内）
- 按获得时间先后顺序过期（FIFO）
- 过期记录完整追踪

**价值**：
- 促进积分使用，提升活跃度
- 防止积分无限累积
- 保证积分系统健康运行

---

### 7.6 自动化业务流程

**创新点**：
- Observer模式实现自动化触发
- 订单支付自动发放积分
- 评价创建自动发放积分
- 评价采纳自动发放奖励
- 订单评价完成自动完成订单

**价值**：
- 减少人工操作，提升效率
- 保证流程一致性
- 避免遗漏和错误

---

### 7.7 内容安全防护

**创新点**：
- 不文明语言自动检测
- 中英文敏感词库
- 评价内容和标签联合检测
- 频率限制防止刷评

**价值**：
- 保证内容质量
- 提升用户体验
- 减少人工审核成本

---

### 7.8 完整的审计日志系统

**创新点**：
- 所有关键操作记录审计日志
- 积分交易完整追踪
- 评价追踪更新记录
- 数据变更可追溯

**价值**：
- 保证系统安全性
- 支持合规性审计
- 便于问题排查

---

### 7.9 智能排队系统

**创新点**：
- 在线排队，无需到店
- 实时位置和预计时间
- 按时间段智能生成排队号
- 支持桌位类型偏好

**价值**：
- 提升用户体验
- 减少现场等待时间
- 便于运营管理

---

### 7.10 数据驱动决策

**创新点**：
- 多维度统计分析
- 积分来源统计
- 积分排行榜
- 异常检测统计
- 评价分布统计

**价值**：
- 支持数据驱动决策
- 发现运营问题
- 优化运营策略

---

## 8. 总结

本系统通过技术创新和业务创新，在传统火锅餐饮管理系统的基础上，实现了以下突破：

1. **用户体验提升**：可视化桌位选择、实时排队信息、便捷的预约和评价流程
2. **运营效率优化**：自动化业务流程、智能数据分析、异常监控预警
3. **客户关系管理**：积分会员体系、精准营销、评价追踪优化
4. **数据驱动决策**：多维度统计分析、异常检测、运营报表

特别是**评价追踪优化机制**和**积分异常检测系统**，这两个创新功能将用户反馈转化为实际改进措施，并通过异常检测保证系统公平性，形成了"用户评价-商家采纳-持续优化-用户反馈"的完整闭环，是传统餐饮系统所不具备的核心竞争力。

---

**文档版本**：v1.0  
**最后更新**：2026-01-15  
**文档作者**：eBrook Group Development Team

